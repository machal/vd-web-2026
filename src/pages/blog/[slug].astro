---
import { Fragment } from 'astro/jsx-runtime';
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ArticleHeader from '../../components/ArticleHeader.astro';
import ArticleFooter from '../../components/ArticleFooter.astro';
import { categories, type CategoryConfig } from '../../data/categories';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Normalizace tagu (odstranění diakritiky pro porovnávání)
function normalizeTag(tag: string): string {
  return tag
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');
}

// Najít kategorie, které odpovídají tagům článku
function getCategoriesForPost(postTags: string[] = []): CategoryConfig[] {
  const normalizedPostTags = postTags.map(normalizeTag);
  return categories.filter(category => {
    return category.tags.some(catTag => {
      const normalizedCatTag = normalizeTag(catTag);
      return normalizedPostTags.includes(normalizedCatTag);
    });
  });
}

const postCategories = getCategoriesForPost(post.data.tags);

// Debug: zobrazit tagy a kategorie
// console.log('Post tags:', post.data.tags);
// console.log('Post categories:', postCategories);
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  ogType="article"
  ogUrl={`https://www.vzhurudolu.cz/blog/${post.slug}`}
  bodyClass="section-blog"
>
  <Header slot="header" />
  <Footer slot="footer" />

  <Fragment slot="styles">
    <link rel="stylesheet" href="/assets/css/modules-standalone/min/article-foot.min.css" />
    <link rel="stylesheet" href="/assets/css/modules-standalone/min/related.min.css" />
    <style>
      /* Related articles/links */
      .related {
        margin: 2rem 0;
        padding: 1rem;
        background: var(--vd-box-bg-color);
        border-left: 3px solid var(--vd-link-color);
        border-radius: 0.25rem;
      }
      
      .related ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      
      .related li {
        margin-bottom: 0.5rem;
      }
      
      .related li:last-child {
        margin-bottom: 0;
      }
      
      .related a {
        color: var(--vd-text-color);
        text-decoration: none;
      }
      
      .related a:hover,
      .related a:focus,
      .related a:active {
        color: var(--vd-link-color);
        text-decoration: underline;
        text-decoration-color: var(--vd-link-color);
      }
      
      /* Anchor links in headings - show "#" on hover */
      /* Anchor links in headings - show "#" on hover */
      @media only screen and (min-width: 740px) {
        .article h1[id] > a,
        .article h2[id] > a,
        .article h3[id] > a,
        .article h4[id] > a,
        .article h5[id] > a {
          position: relative;
        }
        
        .article h1[id] > a:hover::before,
        .article h1[id] > a:focus::before,
        .article h1[id] > a:active::before,
        .article h2[id] > a:hover::before,
        .article h2[id] > a:focus::before,
        .article h2[id] > a:active::before,
        .article h3[id] > a:hover::before,
        .article h3[id] > a:focus::before,
        .article h3[id] > a:active::before,
        .article h4[id] > a:hover::before,
        .article h4[id] > a:focus::before,
        .article h4[id] > a:active::before,
        .article h5[id] > a:hover::before,
        .article h5[id] > a:focus::before,
        .article h5[id] > a:active::before {
          content: "#";
          position: absolute;
          left: -1.25rem;
          color: rgba(53, 91, 12, 0.3);
        }
        
        .article h1[id],
        .article h2[id],
        .article h3[id],
        .article h4[id],
        .article h5[id] {
          padding-left: 1.5rem;
          margin-left: -1.5rem;
        }
      }
    </style>
  </Fragment>

  <main role="main" id="main" aria-label="Hlavní obsah">
    <ArticleHeader 
      title={post.data.title}
      author={post.data.author}
      date={post.data.date}
    />

    <div class="content">
      <div class="article">
        <Content />
      </div>
    </div>

    <ArticleFooter post={post} categories={postCategories} />
  </main>
  
  <script is:inline src="/assets/js/vrdl.min.js"></script>
</BaseLayout>
