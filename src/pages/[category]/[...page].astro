---
// Stránkování kategorií - /{category}/p=2, /{category}/p=3, atd.
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import CategoryTOC from '../../components/CategoryTOC.astro';
import CategoryTOCResponzivniDesign from '../../components/categories/CategoryTOCResponzivniDesign.astro';
import CategoryTOCOrganizaceCSS from '../../components/categories/CategoryTOCOrganizaceCSS.astro';
import CategoryTOCNastroje from '../../components/categories/CategoryTOCNastroje.astro';
import CategoryTOCRychlostNacitani from '../../components/categories/CategoryTOCRychlostNacitani.astro';
import CategoryTOCCSS from '../../components/categories/CategoryTOCCSS.astro';
import ArticleListItem from '../../components/ArticleListItem.astro';
import { getCollection } from 'astro:content';
import { getCategoryBySlug, categories } from '../../data/categories';
import { Fragment } from 'astro/jsx-runtime';

export async function getStaticPaths() {
  // Načtení všech článků pro výpočet počtu stránek
  const blogPosts = await getCollection('blog');
  const podcasts = await getCollection('podcast');
  // Filtrovat pouze články s front matter (mají id)
  const priruckaPosts = await getCollection('prirucka', (entry) => !!entry.data.id);

  const postsPerPage = 10;
  const paths: Array<{
    params: { category: string; page: string };
    props: {
      currentPage: number;
      totalPages: number;
      allContent: any[];
      postsPerPage: number;
      categoryConfig: any;
    };
  }> = [];

  // Pro každou kategorii vypočítat počet stránek
  for (const category of categories) {
    const categoryConfig = getCategoryBySlug(category.slug);
    if (!categoryConfig) continue;

    // Filtrování článků podle tagů kategorie - pouze podle tags
    const allContent = [...blogPosts, ...podcasts, ...priruckaPosts]
      .filter(post => {
        // Filtrovat jen publikované články
        if (post.collection === 'prirucka') {
          if (post.data.published !== true) return false;
          // Filtrovat nehotové snippety - pokud title === id, pak to není hotový článek
          if (post.data.title === post.data.id) return false;
        } else {
          if (post.data.published === false) return false;
        }
        
        // Filtrování pouze podle tags
        const tags = post.data.tags || [];
        return categoryConfig.tags.some(catTag => tags.includes(catTag));
      })
      .sort((a, b) => {
        const dateA = a.data.date || new Date(0);
        const dateB = b.data.date || new Date(0);
        return dateB.getTime() - dateA.getTime();
      });

    const totalPages = Math.ceil(allContent.length / postsPerPage);

    // Vytvořit statické cesty pro všechny stránky této kategorie
    for (let i = 1; i <= totalPages; i++) {
      paths.push({
        params: { category: category.slug, page: `p=${i}` },
        props: {
          currentPage: i,
          totalPages,
          allContent,
          postsPerPage,
          categoryConfig,
        },
      });
    }
  }

  return paths;
}

const { category, page } = Astro.params;
const { currentPage, totalPages, allContent, postsPerPage, categoryConfig } = Astro.props;

if (!category || !categoryConfig) {
  return Astro.redirect('/404');
}

const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const paginatedPosts = allContent.slice(startIndex, endIndex);

function getTOCComponent(categorySlug: string) {
  switch (categorySlug) {
    case 'responzivni-design':
      return CategoryTOCResponzivniDesign;
    case 'organizace-css':
      return CategoryTOCOrganizaceCSS;
    case 'nastroje':
      return CategoryTOCNastroje;
    case 'rychlost-nacitani':
      return CategoryTOCRychlostNacitani;
    case 'css':
      return CategoryTOCCSS;
    default:
      return null;
  }
}

const TOCComponent = getTOCComponent(category);
---

<BaseLayout
  title={`Téma „${categoryConfig.title}" – stránka ${currentPage} na Vzhůru dolů`}
  description={categoryConfig.description}
  bodyClass="section-home"
  ogUrl={`https://www.vzhurudolu.cz/${category}`}
>
  <Fragment slot="styles">
    <link rel="stylesheet" href="/assets/css/modules-standalone/min/topbar.min.css" />
    <link rel="stylesheet" href="/assets/css/modules-standalone/min/toc.min.css" />
  </Fragment>

  <Header slot="header" />
  <Footer slot="footer" />

  <main role="main" id="main" aria-label="Hlavní obsah">
    <div class="page-head page-head--lower">
      <h1>{categoryConfig.title}</h1>
      <div class="mb-0 maxw-30em">
        <p>{categoryConfig.description}</p>
      </div>
    </div>

    {categoryConfig.hasTOC && TOCComponent && (
      <CategoryTOC category={category}>
        <TOCComponent />
      </CategoryTOC>
    )}

    <div class="section">
      <div class="content">
        {paginatedPosts.map((post) => (
          <ArticleListItem post={post} />
        ))}

        {/* Navigace stránkování */}
        <nav class="ta-c mt-3" aria-label="Stránkování">
          {currentPage > 1 && (
            <a class="button" href={currentPage === 2 ? `/${category}` : `/${category}/p=${currentPage - 1}`}>
              ← Předchozí stránka
            </a>
          )}
          
          <span class="mx-1 f-6">
            Stránka {currentPage} z {totalPages}
          </span>
          
          {currentPage < totalPages && (
            <a class="button" href={`/${category}/p=${currentPage + 1}`}>
              Další stránka →
            </a>
          )}
        </nav>
      </div>
    </div>
  </main>
</BaseLayout>
